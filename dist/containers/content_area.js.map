{"version":3,"sources":["../../src/containers/content_area.js"],"names":["dataComposer","onData","context","contentId","entities","sampleContent","Meteor","Collections","i18n","contentLoaded","subscribe","ready","locale","getLocale","content","Contents","findOne","initialEditorState","CompositeDecorator","stateComposer","LocalState","Roles","canEdit","userIsInRole","userId","cancelEditing","delete","isEditing","equals","startEditing","set","pluginComposer","blockPluginProps","blockPlugins","megadraftBlockPlugins","map","plugin","entityInputs","e","inputComponent","i18nComposer","editorState","setEditorState","manulDraft","highlightEditable","copyLocales","value","copyFromLocale","fromContent","fromLocale","newContentState","convertFromRaw","newContent","Modifier","replaceWithFragment","getCurrentContent","getSelection","getBlockMap","newEditorState","EditorState","push","depsMapper","actions","save","cm","saveAndClose","editor","convertToRaw","error","saveAndEdit","cancel","blockPluginDialogIsActive","block","getData","get","getBlocksAsArray"],"mappings":"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","file":"content_area.js","sourcesContent":["import { DraftJS, editorStateFromRaw } from 'megadraft';\nimport {\n  any,\n  invoke,\n  defer,\n  keys,\n  filter,\n  isEmpty,\n  flow,\n  get,\n  keyBy,\n  mapValues,\n} from 'lodash/fp';\nimport { useDeps, composeAll, compose } from '@storybook/mantra-core';\nimport {\n  withProps,\n  withState,\n  withPropsOnChange,\n  withHandlers,\n  onlyUpdateForKeys,\n} from 'recompose';\n\nimport ContentArea from '../components/content_area';\nimport composeWithTracker from '../utils/composeWithTracker';\n\nexport const dataComposer = (\n  { context, contentId, entities = [], sampleContent = null },\n  onData,\n) => {\n  const { Meteor, Collections, i18n } = context();\n  const contentLoaded = Meteor.subscribe('contents.one', contentId).ready();\n  const locale = i18n.getLocale();\n  const content = Collections.Contents.findOne(contentId);\n  if (contentLoaded) {\n    const initialEditorState = editorStateFromRaw(\n      content ? get(`value.${locale}`, content) : sampleContent,\n      new DraftJS.CompositeDecorator(entities || []),\n    );\n    onData(null, { content, locale, initialEditorState });\n  }\n};\n\nexport const stateComposer = ({ context, contentId }, onData) => {\n  const { LocalState, Roles, Meteor } = context();\n  const canEdit = Roles.userIsInRole(Meteor.userId(), 'admin');\n  const cancelEditing = () => LocalState.delete('cm.editingMode');\n  const isEditing = LocalState.equals('cm.editingMode', contentId);\n  const startEditing = () => LocalState.set('cm.editingMode', contentId);\n  onData(null, { canEdit, isEditing, cancelEditing, startEditing });\n};\n\nexport const pluginComposer = (\n  { blockPluginProps = {}, isEditing, entities = [], blockPlugins = [] },\n  onData,\n) => {\n  // megadraft has no concept of editing/readonly (yet)\n  // so we init every plugin with the editingState\n  // in order to display a different component when isEditing/not isEditing\n  onData(null, {\n    megadraftBlockPlugins: blockPlugins.map(plugin =>\n      plugin({ isEditing, blockPluginProps }),\n    ),\n    entityInputs: flow(keyBy('_id'), mapValues(e => e.inputComponent))(\n      entities,\n    ),\n  });\n};\n\nexport const i18nComposer = (\n  { context, content, editorState, setEditorState },\n  onData,\n) => {\n  const { manulDraft } = context();\n  const highlightEditable = invoke('highlightEditable', manulDraft);\n  // keys in value are locales where we can copy from\n  const copyLocales =\n    content &&\n    flow(keys, filter(locale => !isEmpty(get(['value', locale], content))))(\n      content.value,\n    );\n\n  const copyFromLocale = fromLocale => {\n    // clone the content\n    const fromContent = get(`value.${fromLocale}`, content);\n    if (fromContent) {\n      // some draftjs voodoo to insert the rawContent into the current selection\n      const newContentState = DraftJS.convertFromRaw(fromContent);\n      const newContent = DraftJS.Modifier.replaceWithFragment(\n        editorState.getCurrentContent(),\n        editorState.getSelection(),\n        newContentState.getBlockMap(),\n      );\n      const newEditorState = DraftJS.EditorState.push(\n        editorState,\n        newContent,\n        'insert-fragment',\n      );\n      setEditorState(newEditorState);\n    }\n  };\n  onData(null, { copyLocales, highlightEditable, copyFromLocale });\n};\n\nexport const depsMapper = (context, actions) => ({\n  context: () => context,\n  save: actions.cm.save,\n  ...context.manulDraft,\n});\n\nexport default composeAll(\n  composeWithTracker(i18nComposer),\n  // wait for https://github.com/acdlite/recompose/issues/259\n  // this here is a dirty workaround\n  withPropsOnChange(\n    ['initialEditorState'],\n    ({ initialEditorState, setEditorState }) => {\n      /* eslint lodash-fp/no-unused-result: 0*/\n      defer(() => setEditorState(initialEditorState));\n    },\n  ),\n  withHandlers({\n    saveAndClose: ({\n      save,\n      cancelEditing,\n      editorState,\n      contentId,\n      locale,\n    }) => () => {\n      save(\n        {\n          contentId,\n          locale,\n          editor: DraftJS.convertToRaw(editorState.getCurrentContent()),\n        },\n        error => !error && cancelEditing(false),\n      );\n    },\n    saveAndEdit: ({ save, editorState, contentId, locale }) => () => {\n      save({\n        contentId,\n        locale,\n        editor: DraftJS.convertToRaw(editorState.getCurrentContent()),\n      });\n    },\n    cancel: ({ cancelEditing, setEditorState, initialEditorState }) => () => {\n      setEditorState(initialEditorState);\n      cancelEditing(false);\n    },\n  }),\n  withProps(({ editorState }) => ({\n    blockPluginDialogIsActive: any(block => block.getData().get('showDialog'))(\n      editorState.getCurrentContent().getBlocksAsArray(),\n    ),\n  })),\n  withState(\n    'editorState',\n    'setEditorState',\n    ({ initialEditorState }) => initialEditorState,\n  ),\n  composeWithTracker(dataComposer),\n  compose(pluginComposer),\n  composeWithTracker(stateComposer),\n  useDeps(depsMapper),\n  onlyUpdateForKeys(['contentId']),\n)(ContentArea);\n"]}